#!../../gen/bootstrap.py

layouts:

  spread:
  - master -> worker

  gather:
  - master <- worker

topologies:

  spread:
    type: pipeline
    layout: spread

  gather:
    type: pipeline
    layout: gather


services:

  worker:
    worker: python2 /code/factor_processor.py --pullpush $URL_SPREAD $URL_GATHER

  master:
    gen_numbers: python2 /code/gen_numbers.py --rate-limit $RATE_LIMIT --topology $URL_SPREAD
    checker: python2 /code/factor_pull.py --topology $URL_GATHER

tests:

  light:
    duration: 120
    vars:
      RATE_LIMIT: 100
    instances:
      worker: 2

  medium:
    duration: 120
    vars:
      RATE_LIMIT: 1000
    instances:
      worker: 2

  heavy:
    duration: 120
    vars:
      RATE_LIMIT: 100000
    instances:
      worker: 3

  drop:
    duration: 180
    vars:
      RATE_LIMIT: 1000
    instances:
      worker: 2
    timeline:
      30:
      - node: worker1
        exec: sudo iptables -A test-chain -p tcp --dport 20000 -j DROP
      60:
      - node: worker1
        exec: sudo iptables -D test-chain 1
      90:
      - node: worker0
        exec: sudo iptables -A test-chain -p tcp --dport 20000 -j DROP
      120:
      - node: worker0
        exec: sudo iptables -D test-chain 1


